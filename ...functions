# python project prep
pyprep() {
  # centralizing my venvs
  rt_ve_dir=~/.python_venvs
  prj_name="${PWD##*/}"
  prj_ve_dir="${rt_ve_dir}/${prj_name}"
  # create the virtual environment
  python3 -m venv $prj_ve_dir
  # activate it
  source $prj_ve_dir/bin/activate
  # install dependencies in the virtual env
  $prj_ve_dir/bin/python -m pip install -r requirements.txt
}

# sidecar
sidecar() {
  if pgrep -x 'System Preferences' >/dev/null
  then
      killall 'System Preferences'
  fi
  osascript -e '
  tell application "System Preferences"
  activate
  reveal pane id "com.apple.preference.sidecar"
  delay 1

  tell application "System Events" to click first menu button of first window of application process "System Preferences" of application "System Events"
  tell application "System Events" to click first menu item of first menu of first menu button of first window of application process "System Preferences" of application "System Events"

  quit
  end tell'
}

# simple calculator
calc() {
	local result=""
	result="$(printf "scale=10;%s\\n" "$*" | bc --mathlib | tr -d '\\\n')"
	#						└─ default (when `--mathlib` is used) is 20

	if [[ "$result" == *.* ]]; then
		# improve the output for decimal numbers
		# add "0" for cases like ".5"
		# add "0" for cases like "-.5"
		# remove trailing zeros
		printf "%s" "$result" |
			sed -e 's/^\./0./'  \
			-e 's/^-\./-0./' \
			-e 's/0*$//;s/\.$//'
	else
		printf "%s" "$result"
	fi
	printf "\\n"
}

mdl () {
  you-get --output-dir ~/iCloud/memes --no-caption "$1"
}
fuckice ()
{
  gert --output ~/Desktop/evidence-of-republican-tyrany-and-domestic-terrorism/ --human-readable "$1"
}

fi_arch ()
{
  gert --output ~/Desktop/evidence-of-republican-tyrany-and-domestic-terrorism/ --human-readable --feed new -limit 1000 -s ICE_Watch 
}


nprj() {
  if [ -z "$1" ]; then
    echo "Please provide a repository URL."
    return 1
  fi

  repo_name=$(basename -s .git "$1")

  target_dir="$HOME/Projects/$repo_name"

  git clone "$1" "$target_dir"

  if [ $? -ne 0 ]; then
    echo "Failed to clone repository."
    return 1
  fi

  code "$target_dir"
}

grab_code () {
  # Define the project root and output README.md file
  PROJECT_ROOT="$1"  # Pass the project root as the first argument
  OUTPUT_FILE="$(basename "$PROJECT_ROOT").md"  # Set output file name to the project root directory name with .md

  # Check if a directory is provided
  if [[ -z "$PROJECT_ROOT" || ! -d "$PROJECT_ROOT" ]]; then
      echo "Usage: $0 <project_root_directory>"
      exit 1
  fi

  # Initialize or clear the README.md file
  echo "# Project Files" > "$OUTPUT_FILE"
  echo "" >> "$OUTPUT_FILE"

  # Function to process files recursively
  process_files() {
      local dir="$1"
      for file in "$dir"/*; do
          if [[ -d "$file" ]]; then
              # If it's a directory, recurse into it
              process_files "$file"
          elif [[ -f "$file" ]]; then
              # If it's a file, append its content to README.md
              local relative_path="${file#$PROJECT_ROOT/}"
              echo "## \`$relative_path\`" >> "$OUTPUT_FILE"
              echo '```' >> "$OUTPUT_FILE"
              cat "$file" >> "$OUTPUT_FILE"
              echo '```' >> "$OUTPUT_FILE"
              echo "" >> "$OUTPUT_FILE"
          fi
      done
  }

  # Start processing files from the project root
  process_files "$PROJECT_ROOT"

  # Notify the user
  echo "Markdown file '$OUTPUT_FILE' has been generated with the content of all files in the project."

}

# intercept only: `git init`, `git init .`, `git clone <url>`, `git clone <url> <dir>`
git() {
  if [ "$1" = "init" ] && { [ $# -eq 1 ] || { [ $# -eq 2 ] && [ "$2" = "." ]; }; }; then
    local name="${PWD##*/}"
    local gitdir="$HOME/.gitdirs/${name}.git"
    mkdir -p "$HOME/.gitdirs"
    echo "using separate-git-dir: $gitdir"
    command git init --separate-git-dir "$gitdir" .
    return
  fi

  if [ "$1" = "clone" ] && { [ $# -eq 2 ] || [ $# -eq 3 ]; }; then
    local url="$2"
    local target
    if [ $# -eq 3 ]; then
      target="$3"
    else
      # derive target folder from URL basename, stripping trailing .git
      local base="${url##*/}"
      target="${base%.git}"
    fi
    local name="${target##*/}"
    local gitdir="$HOME/.gitdirs/${name}.git"
    mkdir -p "$HOME/.gitdirs"
    echo "using separate-git-dir: $gitdir"
    command git clone --separate-git-dir "$gitdir" "$url" "$target"
    return
  fi

  command git "$@"
}
mnp() {
  cd /Volumes/media
  pyprep
  mnamer \
  --media=movie \
  --movie-api=tmdb \
  --batch \
  --recurse \
  --movie-directory "/Volumes/media/movies/{name} ({year}) {tmdb-{id_tmdb}}" \
  --movie-format "{name} ({year}) {tmdb-{id_tmdb}}{extension}" \
  "/Volumes/media/pending" \
  && find /Volumes/media/pending -type d -empty -delete
}

mqa() {
  local root="/Volumes/media/movies"

  # finds directories (movies) that either:
  # - do not contain "{tmdb-...}" at all, or
  # - contain the blank placeholder "{tmdb-}"
  find "$root" -type d -print0 |
  while IFS= read -r -d '' d; do
    local base="${d##*/}"

    # skip common noise dirs
    case "$base" in
      .git|.Trash|.Trashes|@eaDir|lost+found) continue ;;
    esac

    if [[ "$base" == *"{tmdb-}"* ]]; then
      printf '%s\n' "$d"
      continue
    fi

    if [[ "$base" != *"{tmdb-"* ]]; then
      printf '%s\n' "$d"
      continue
    fi

    if [[ ! "$base" =~ \{tmdb-[0-9]+\} ]]; then
      printf '%s\n' "$d"
      continue
    fi
  done
  find "$root" -type d -print0 |
  while IFS= read -r -d '' d; do
    local base="${d##*/}"

    case "$base" in
      .git|.Trash|.Trashes|@eaDir|lost+found) continue ;;
    esac

    local file_count
    file_count="$(find "$d" -maxdepth 1 -type f 2>/dev/null | wc -l | tr -d ' ')"

    if [[ "$file_count" -gt 1 ]]; then
      printf '%s\n' "$d"
    fi
  done
}